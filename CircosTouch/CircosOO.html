<html>
	<head>
		<title>	Circos Plots</title>
		<script type="text/javascript" src="Components.js"></script>
		<script type="text/javascript" src="CircosObjects.js"></script>
		<script type="text/javascript" src="GenomicBuild.js"></script>
		<script src="https://github.com/sidelab/interact/raw/master/interact.js"></script>
	</head>
	<body>
		<canvas id="circosPlot1" width=500 height=500>
		</canvas>
		<canvas id="circosPlot2" width=500 height=500>
		</canvas>
		<canvas id="circosPlot3" width=500 height=500>
		</canvas>
		<script type="text/javascript">
			var snd = new Audio("dingding.wav");
			snd.play();
		</script>
		<script type="text/javascript">
			console.log("version: .35");
			
			var canvas = document.getElementById("circosPlot1");
			var canvasContext = canvas.getContext("2d");
			
			buildPlotFromFile("http://chaos-somanayr.googlecode.com/svn/trunk/CircosTouch/edges.txt", {curveRadius:100, chrOff:120, chrThickness:20, innerOff:100, innerThickness:20}, 500, 500, function(plot){sccp = plot; sccp.render(canvasContext)});
			
			var rot = 0;
			
			/* 
			 * Touch listeners
			 */
			var eventMonitor = INTERACT.watch(canvas, {
				detailed : true
			});
			var p1 = {
				col : "#00FF00",
				id : -1
			}, p2 = {
				col : "#0000FF",
				id : -1
			};
			var lastAngle = -1;
			var dist = -1;
			var angle = 0;
			var pos = -1;
			// handle pointer down events
			eventMonitor.bind('pointerDownMulti', function(evt, absXY, relXY) {
				var touchData = relXY;
				var p1Valid = false, p2Valid = false;
				while(touchData){
					if(touchData.id == p1.id){
						p1Valid = true;
					} else if (touchData.id == p2.id){
						p2Valid = true
;					}
					touchData = touchData.next;
				}
				console.log('Is p1 valid: ' + p1Valid);
				console.log('Is p2 valid: ' + p2Valid);
				touchData = relXY;
				while(touchData) {
					if(!p1Valid) {
						p1.id = touchData.id;
						p1.x = touchData.x;
						p1.y = touchData.y;
						p1Valid = true;
					} else if(!p2Valid) {
						p2.id = touchData.id;
						p2.x = touchData.x;
						p2.y = touchData.y;
						p2Valid = true;
					}
					if(p1Valid && p2Valid){
						lastAngle = getAngle(p1, p2);
						dist = distance(p1,p2) / sccp.renderingRules.scale;
						console.log('p1: (' + p1.x + ', ' + p1.y + ')');
						console.log('p2: (' + p2.x + ', ' + p2.y + ')');
						console.log("2 touch");
						pos = -1;
					}
					if((!p1Valid || !p2Valid) && (p1Valid || p2Valid)){ //one touch
						console.log("1 touch");
						pos = touchData;
					}
					touchData = touchData.next;
					angle = sccp.renderingRules.rotation;
				} // while
			});
			
			// handle moves
			eventMonitor.bind('pointerMoveMulti', function(evt, absXY, relXY) {
				var touchData = relXY;

				while(touchData) {
					var col = -1;
					if(touchData.id == p1.id) {
						col = p1.col;
						p1.x = touchData.x;
						p1.y = touchData.y;
					} else if(touchData.id == p2.id) {
						col = p2.col;
						p2.x = touchData.x;
						p2.y = touchData.y;
					}
					touchData = touchData.next;
				} // whiles
				if((p1.id == -1 || p2.id == -1) && (p1.id != -1 || p2.id != -1) && pos != -1){ //one touch
					var deltaX = pos.x - relXY.x;
					var deltaY = pos.y - relXY.y;
					sccp.center.x -= deltaX;
					sccp.center.y -= deltaY;
					pos = relXY;
					canvasContext.save();
					canvasContext.clearRect(0,0,500,500);
					sccp.render(canvasContext);
					canvasContext.restore();
				} else if(p2.id != -1 && p1.id != -1){
					var thisAngle = getAngle(p1, p2);
					angle += (thisAngle - lastAngle);
					angle %= Math.PI * 2;
					lastAngle = thisAngle;
					
					var thisDist = distance(p1, p2);
					var scale = thisDist / dist;
					sccp.renderingRules.scale = scale;
					sccp.renderingRules.rotation = angle;
					canvasContext.save();
					canvasContext.clearRect(0,0,500,500);
					sccp.render(canvasContext);
					canvasContext.restore();
				}
			});
			
			// handle pointer up events
			eventMonitor.bind('pointerUpMulti', function(evt, absXY, relXY, deltaXY) {
				if(relXY.id == p1.id) {
					p1.id = -1;
					dist = lastAngle = -1;
				}
				if(relXY.id == p2.id) {
					p2.id = -1;
					dist = lastAngle = -1;
				}
				pos = -1;
				console.log();
			});
			
			function getAngle(center, location){
				var x = location.x - center.x;
				var y = location.y - center.y;
				if(x == 0 && y > 0)
					return Math.PI / 2;
				if(x == 0 && y < 0)
					return 3 * Math.PI / 2;
				if(y == 0 && x > 0)
					return 0;
				if(y == 0 && x < 0)
					return Math.PI;
				var angle = Math.atan(y/x);
				if(x > 0 && y > 0)
					return angle;
				if(x < 0)
					return Math.PI + angle
				return Math.PI * 2 + angle;
			}
			
			function distance(p1, p2){
				return Math.sqrt((p2.x - p1.x) * (p2.x - p1.x) + (p2.y - p1.y) * (p2.y - p1.y));
			}
		</script>
	</body>
</html>